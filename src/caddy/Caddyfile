app.localhost:443 {
    tls /etc/ssl/local/app.localhost.pem /etc/ssl/local/app.localhost-key.pem

    encode gzip

    # --- Security headers (apply to everything served on this site) ---
    header {
        # PHASE 1 (non-breaking): allows current inline <script> and inline style attributes.
        Content-Security-Policy "
          default-src 'self';
          script-src 'self' 'unsafe-inline';
          style-src  'self' 'unsafe-inline';
          img-src    'self' data:;
          font-src   'self' data:;
          connect-src 'self';
          object-src 'none';
          base-uri 'none';
          frame-ancestors 'none';
          form-action 'self'
        "

        # When we refactor JS into external files (no inline), switch to this stricter CSP:
        # Content-Security-Policy "
        #   default-src 'self';
        #   script-src 'self';
        #   style-src  'self';
        #   img-src    'self' data:;
        #   font-src   'self' data:;
        #   connect-src 'self';
        #   object-src 'none';
        #   base-uri 'none';
        #   frame-ancestors 'none';
        #   form-action 'self';
        #   require-trusted-types-for 'script'
        # "

        Referrer-Policy        "no-referrer"
        X-Content-Type-Options "nosniff"
        X-Frame-Options        "DENY"

        # Cross-origin isolation hardening (safe since all assets are same-origin)
        Cross-Origin-Opener-Policy  "same-origin"
        Cross-Origin-Embedder-Policy "require-corp"
        Cross-Origin-Resource-Policy "same-origin"
    }

    reverse_proxy crs-proxy:8000 {
        header_up Host              {host}
        header_up X-Forwarded-Host  {host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-For   {remote}
    }
}

